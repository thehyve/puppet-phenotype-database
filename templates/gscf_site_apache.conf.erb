<VirtualHost <%= @vhost_name %>:<%= @port %>>
    <%= scope.function_template(['apache_ext/_vhost-common.erb']) %>

    RewriteEngine on

    # keep listening for the serveralias, but redirect to
    # servername instead to make sure only one user session
    # is created (tomcat will create one user session per
    # domain which may lead to two (or more) usersessions
    # depending on the number of serveraliases)
    # see gscf ticket #321
    RewriteCond %{HTTP_HOST} !^<%= @srvname %>$ [NC]
    RewriteRule .* http<%= @ssl ? 's' : '' %>://<%= @srvname %>$0 [R=301,QSA,L]

    # rewrite the /gscf-a.b.c-environment/ part of the url                
    RewriteRule ^/gscf-[^/]+/(.*) /$1 [L,PT,NC,NE]

    ProxyStatus On
    ProxyPass / <%= @dest %> stickysession=JSESSIONID|jsessionid nofailover=On timeout=7200
    ProxyPassReverseCookiePath /gscf-<%= @extra_variables['instancename'] %> /
    ProxyTimeout 7200

    <Location />
        SetOutputFilter proxy-html
        ProxyHTMLDoctype XHTML Legacy
        ProxyHTMLURLMap /gscf-<%= @extra_variables['instancename'] %>/ /
    </Location>

    <Proxy balancer://gscf-cluster>
        BalancerMember ajp://localhost:<%= @extra_variables['ajp_port'] %>
        ProxySet timeout=7200
    </Proxy>
</VirtualHost>
