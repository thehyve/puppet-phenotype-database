NameVirtualHost <%= vhost_name %>:<%= port %>
<VirtualHost <%= vhost_name %>:<%= port %>>
    ServerName <%= srvname %>
    <% if serveraliases.is_a? Array %>
        <% serveraliases.each do |name| %><%= "  ServerAlias #{name}\n" %><% end %>
    <% elsif serveraliases != '' %>
        <%= "  ServerAlias #{serveraliases}" %>
    <% end %>

    ErrorLog /var/log/<%= scope.lookupvar("apache::params::apache_name") %>/<%= name %>_error.log
    LogLevel warn
    <% if access_log -%>
        CustomLog /var/log/<%= scope.lookupvar("apache::params::apache_name") %>/<%= name %>_access.log combined
    <% end -%>

    RewriteEngine on

    # keep listening for the serveralias, but redirect to
    # servername instead to make sure only one user session
    # is created (tomcat will create one user session per
    # domain which may lead to two (or more) usersessions
    # depending on the number of serveraliases)
    # see gscf ticket #321
    RewriteCond %{HTTP_HOST} !^<%= srvname %>$ [NC]
    RewriteRule .* http://<%= srvname %>$0 [R=301,QSA,L]

    # rewrite the /gscf-a.b.c-environment/ part of the url                
    RewriteRule ^/gscf-[^/]+/(.*) /$1 [L,PT,NC,NE]

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    ProxyStatus On
    ProxyPass / <%= dest %> stickysession=JSESSIONID|jsessionid nofailover=On
    ProxyPassReverseCookiePath /gscf-<%= scope.lookupvar('phenotypedb::phenotypedbapp::phenotypedbwarid') %> /

    <Location />
        SetOutputFilter proxy-html
        ProxyHTMLDoctype XHTML Legacy
        ProxyHTMLURLMap /gscf-<%= scope.lookupvar('phenotypedb::phenotypedbapp::phenotypedbwarid') %>/ /
    </Location>

    <Proxy balancer://gscf-cluster>
        BalancerMember ajp://localhost:8<%= scope.lookupvar('phenotypedb::phenotypedbapp::number') %>09
    </Proxy>
</VirtualHost>
